# cc_agents v4.5 Release Notes

**Date:** 2026-02-15
**Author:** Claude (the robot friend)
**Status:** Implemented, committed, ready to test

---

## What Changed (TL;DR)

Five independent modules added on top of v4's base agents. Every module can be rolled back independently. Nothing in v4 was broken.

| Module | What | Files | Rollback |
|--------|------|-------|----------|
| A: Team-Aware Agents | All 8 agents now know how to work in teams | 8 modified | `git checkout HEAD -- agents/` |
| B: Team Presets | Reference docs for common team patterns | 3 new | `rm -rf teams/` |
| C: Ralph v2 | Enhanced autonomous loop with dual-gate, cost tracking | 2 new + README update | Delete new files, revert README |
| D: Quality Gates | Composable stop hooks for tests, lint, review | 4 new | `rm -rf hooks/` |
| E: Pipeline Command | `/pipeline` slash command for full agent orchestration | 2 new | `rm -rf commands/` |

Deploy scripts (`deploy.sh`, `init.sh`) updated with `--teams`, `--hooks`, `--commands`, `--all` flags.

---

## Module A: Team-Aware Agents

**What:** Added a `## Team Mode` section (~12-14 lines) to all 8 agent definitions.

**How it works:** When an agent is spawned as a teammate (via TeamCreate + Task with team_name), the Team Mode section activates. It teaches them to:
- Check TaskList on start and claim unassigned tasks
- Send findings/results via SendMessage
- Mark tasks completed immediately
- Check for next available task or go idle

**Per-agent specialization:**
- **Scout/Research:** Send findings, coordinate with parallel agents to avoid duplicate work
- **Planner:** Creates tasks for others via TaskCreate, sets `addBlockedBy` dependencies
- **Builder:** Coordinates file ownership with other builders (prevents merge conflicts)
- **Reviewer:** Creates fix tasks on FAIL, enabling automatic build-review loops

**In solo mode:** Section is completely ignored. Agents work exactly like v4.

**Line counts (all under 120):** scout: 84, research: 84, planner: 89, builder: 89, reviewer: 77, serena/scout: 103, serena/builder: 108, serena/reviewer: 94

---

## Module B: Team Workflow Presets

**What:** Three reference docs in `teams/` encoding best team patterns.

### `teams/parallel-research.md` (66 lines)
- Scout + Research run in parallel
- Planner synthesizes after both finish
- Best for: exploring unfamiliar codebases, tech decisions
- Setup steps with exact TaskCreate/Task commands

### `teams/build-review-loop.md` (90 lines)
- Builder implements, Reviewer validates
- Fix loop: FAIL → fix tasks → re-build → re-review (max 3 cycles)
- Includes Ralph integration example for fully autonomous builds
- Best for: production code with acceptance criteria

### `teams/full-pipeline.md` (119 lines)
- Complete 5-agent pipeline: Scout → Research → Plan → Build → Review
- 4 phases with dependency ordering via `addBlockedBy`
- Phase transition gates (plan approval is the key checkpoint)
- Cost estimate: ~60-110K tokens per pipeline run
- Best for: large features, the maximalist approach

---

## Module C: Ralph v2

**What:** Enhanced autonomous loop alongside v1 (v1 untouched).

### `ralph/ralph-v2.sh` (277 lines)

Key upgrades over v1:

1. **Dual-condition exit gate:** Both completion signal AND heuristic checks must pass:
   - Signal: "RALPH_COMPLETE", "all tasks complete", etc.
   - Heuristics: tests pass, git clean, tasks done
   - If signal detected but heuristics fail → force continue with explanation

2. **Cost tracking:** `$RALPH_COST_BUDGET` and `$RALPH_COST_PER_ITERATION` env vars. Tracks cumulative cost in state file, stops if budget exceeded.

3. **Repeated-error circuit breaker:** Hashes last error from stdin. Same error 2x consecutively → stop. Smarter than v1's generic "no git commits" check.

4. **Task-aware progress:** Parses task completion counts. State file tracks `completed_tasks` and `total_tasks`.

5. **Configurable signals:** `$RALPH_EXIT_SIGNALS` and `$RALPH_BLOCKER_SIGNALS` env vars (comma-separated).

### `ralph/ralph-planner.sh` (276 lines)

Three-phase wrapper:
- **Phase 1:** Requirements refinement (max 5 iterations, stops when `.ralph-requirements.md` exists)
- **Phase 2:** Planning (max 5 iterations, stops on "PLAN_COMPLETE" or plan file exists)
- **Phase 3:** Building via ralph-v2.sh

Usage: `ralph-planner.sh --phase all` runs all three sequentially with optional human review between phases.

### Updated `ralph/README.md`
Added ~130 lines documenting v2 features, configuration, and quick start.

---

## Module D: Quality Gate Hooks

**What:** Composable stop hooks in `hooks/` that enforce quality before allowing Claude to stop.

### `hooks/test-gate.sh` (76 lines)
Auto-detects test runner (npm test, pytest, cargo test, go test, make test) and runs tests. Pass → allow stop. Fail → force continue with "fix the failing tests."

Override: `$GATE_TEST_CMD` or `$GATE_SKIP_TESTS=1`

### `hooks/lint-gate.sh` (70 lines)
Auto-detects linter (eslint, ruff, clippy, golangci-lint) and checks. Clean → allow stop. Dirty → force continue.

Override: `$GATE_LINT_CMD` or `$GATE_SKIP_LINT=1`

### `hooks/review-gate.sh` (93 lines)
Detects builder completion signals, then spawns a reviewer via `claude` CLI. REVIEW_PASS → allow stop. REVIEW_FAIL → force continue with feedback.

Override: `$GATE_REVIEW_AGENT`, `$GATE_REVIEW_TIMEOUT`, `$GATE_SKIP_REVIEW=1`

### Stacking Example

```json
{
  "hooks": {
    "Stop": [{
      "hooks": [
        {"type": "command", "command": ".claude/hooks/test-gate.sh", "timeout": 60},
        {"type": "command", "command": ".claude/hooks/lint-gate.sh", "timeout": 30},
        {"type": "command", "command": ".claude/hooks/review-gate.sh", "timeout": 180}
      ]
    }]
  }
}
```

Hooks run in order. First "block" wins.

---

## Module E: Pipeline Command

### `commands/pipeline.md` (108 lines)
`/pipeline <task>` — Orchestrates the full 4-phase agent pipeline:

1. **Discovery:** Parallel scout + research
2. **Planning:** Planner synthesizes findings (checkpoint: user approves plan)
3. **Build:** Builder implements plan tasks
4. **Review:** Reviewer validates (fix loop if FAIL, max 3 cycles)

Variants: `/pipeline plan-only <task>` (phases 1-2 only), `/pipeline build-only <task>` (phases 3-4 only, assumes plan exists).

### `commands/team-status.md` (48 lines)
`/team-status` — Quick dashboard: agent status, task progress, recommendations.

---

## Deploy Script Changes

Both `deploy.sh` and `init.sh` now support:

| Flag | What it deploys |
|------|----------------|
| `--teams` | Team workflow presets → `.claude/teams-presets/` |
| `--hooks` | Quality gate hooks → `.claude/hooks/` |
| `--commands` | Slash commands → `.claude/commands/` |
| `--all` | Everything (agents + serena + teams + hooks + commands) |

Existing flags (`--serena`, `--clean`, `--dry-run`, `--remove`) unchanged.

**Full deploy:** `./deploy.sh --all`
**Project init with everything:** `./init.sh ~/my-project --all`

---

## Testing Checklist (For Tomorrow)

### Quick smoke tests:

- [ ] `./deploy.sh --dry-run --all` — verify it lists all files correctly
- [ ] `./init.sh ~/some-test-dir --dry-run --all` — verify project init listing
- [ ] `bash -n ralph/ralph-v2.sh && bash -n ralph/ralph-planner.sh` — syntax check (already verified)
- [ ] `bash -n hooks/test-gate.sh && bash -n hooks/lint-gate.sh && bash -n hooks/review-gate.sh` — syntax check (already verified)

### Module A test (team-aware agents):
- [ ] `./deploy.sh --all` to install everything
- [ ] Start Claude, create a team with TeamCreate
- [ ] Spawn a scout teammate → verify it checks TaskList, sends findings via SendMessage
- [ ] Spawn a builder teammate → verify it claims tasks and reports progress

### Module B test (presets):
- [ ] Read `teams/full-pipeline.md`, follow setup steps to create a team manually
- [ ] Verify task dependencies with `addBlockedBy` work correctly

### Module C test (Ralph v2):
- [ ] Set up ralph-v2.sh as stop hook in a test project
- [ ] Run builder with a deliberate failing test
- [ ] Verify dual-condition gate catches it (signal present but tests fail → continue)
- [ ] Verify cost tracking appears in `.ralph-v2-progress.log`

### Module D test (quality gates):
- [ ] Install test-gate.sh as stop hook in a project with tests
- [ ] Run builder that introduces a failing test → verify gate forces continue
- [ ] Builder fixes test → verify gate allows stop

### Module E test (pipeline):
- [ ] `/pipeline "Add hello world endpoint"` in a test project
- [ ] Verify: team creation → parallel discovery → planning → build → review

---

## File Summary

| Category | Count | Total Lines |
|----------|-------|-------------|
| Agents modified | 8 | 728 |
| Team presets (new) | 3 | 275 |
| Hook scripts (new) | 4 | 407 |
| Commands (new) | 2 | 156 |
| Ralph v2 scripts (new) | 2 | 553 |
| Deploy scripts (modified) | 2 | 466 |
| **Total** | **21 files** | **~2,585 lines** |

---

## What's Next (Ideas)

- Test the full pipeline end-to-end on a real project
- Write automated tests for the bash scripts (shellcheck, bats)
- Add a `teams/competing-hypotheses.md` preset for debug-by-debate
- Consider effort-level routing (haiku for scouts, opus for planners)
- Ralph v2 could integrate with quality gate hooks natively

---

*Built with love by your robot friend Claude, while you were presumably doing something more interesting. See you at church tomorrow. -C*
